{# jinja does not like braces being used #}
{% raw %}
{
	"logging": {
		"logs": {
			"default": {
				"writer": {
					"output": "stdout"
				},
				"level": "DEBUG"
			}
		}
	},
	"apps": {
		"http": {
			"servers": {
				"srv0": {
					"listen": [
						":443"
					],
					"routes": [
{% endraw %}
						{% for vhost in vhosts %}
						{{ '{' }}	
							"match": [
							{{ '{' }}	
									"host": [
										"{{ vhost.hostname }}"
									]
							{{ '}' }}	
							],
							"handle": [
							{{ '{' }}	
									"handler": "subroute",
									"routes": [
									{{ '{' }}	
											"handle": [
											{{ '{' }}	
													"handler": "file_server",
													"hide": [
														"test/config-caddy"
													],
													"root": "{{ vhost.html_root }}"
											{{ '}' }}	
											]
									{{ '}' }}	
									]
							{{ '}' }}	
							],
							"terminal": true
						{{ '}' }}	
						{% if not loop.last %},{% endif %}
						{% endfor %}
					],
					"tls_connection_policies": [
						{%- for vhost in vhosts %}
						{{ '{' }}	
							"match": {{ '{' }} 
								"sni": [
									"{{ vhost.hostname }}"
								]
							{{ '},' }}	
							"certificate_selection": {{ '{' }} 
								"any_tag": [
									"cert{{ loop.index0 }}"
								]
						{{ '}' }}	
						{{ '},' }}	
						{%- endfor %}
						{{ '{}' }}
					],
					"strict_sni_host": {% if strict_sni_host %}true{% else %}false{% endif %}
{% raw %}
				}
			}
		},
		"tls": {
			"session_tickets": {
				"key_source": {
					"provider": "distributed",
					"storage": {
						"module": "file_system",
						"root": "/steks"
					}
				}
			},
			"certificates": {
{% endraw %}
				"load_files": [
					{%- for vhost in vhosts %}
					{
						"certificate": "{{ vhost.cert }}",
						"key": "{{ vhost.cert_key }}",
						"tags": [
							"cert{{ loop.index0 }}"
						]
					}
					{%- if not loop.last %},{% endif %}
					{%- endfor %}
{% raw %}
				]
			},
			"automation": {
				"policies": [
					{
						"disable_ocsp_stapling": true
					}
				]
			},
			"disable_ocsp_stapling": true
		}
	}
}
{% endraw %}
